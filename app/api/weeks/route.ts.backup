
import { NextRequest, NextResponse } from 'next/server'
import { requireAuth } from '@/lib/auth'
import { prisma } from '@/lib/prisma'

function getCurrentISOWeek(): string {
  const now = new Date()
  const year = now.getFullYear()
  const week = getISOWeek(now)
  return `${year}-W${week.toString().padStart(2, '0')}`
}

function getISOWeek(date: Date): number {
  const target = new Date(date.valueOf())
  const dayNr = (date.getDay() + 6) % 7
  target.setDate(target.getDate() - dayNr + 3)
  const jan4 = new Date(target.getFullYear(), 0, 4)
  const dayDiff = (target.getTime() - jan4.getTime()) / 86400000
  return 1 + Math.ceil(dayDiff / 7)
}

async function handler(req: NextRequest) {
  if (req.method === 'GET') {
    try {
      const weeks = await prisma.week.findMany({
        include: {
          topics: {
            include: {
              site: { select: { name: true, key: true } },
              category: { select: { name: true } },
            },
          },
        },
        orderBy: { createdAt: 'desc' },
      })
      
      return NextResponse.json({ weeks })
    } catch (error) {
      console.error('Error fetching weeks:', error)
      return NextResponse.json({ error: 'Failed to fetch weeks' }, { status: 500 })
    }
  }
  
  if (req.method === 'POST') {
    try {
      const currentIsoWeek = getCurrentISOWeek()
      
      const week = await prisma.week.upsert({
        where: { isoWeek: currentIsoWeek },
        create: {
          isoWeek: currentIsoWeek,
          status: 'PENDING',
        },
        update: {}, // No update needed if exists
      })
      
      return NextResponse.json({ week })
    } catch (error) {
      console.error('Error creating/fetching week:', error)
      return NextResponse.json({ error: 'Failed to create/fetch week' }, { status: 500 })
    }
  }
  
  return NextResponse.json({ error: 'Method not allowed' }, { status: 405 })
}

export async function GET(req: import("next/server").NextRequest) {
  const unauth = await requireAuth(req);
  if (unauth) return unauth;
  return handler(req);
}
// Replaced for Next.js 14: export a function, not a const
export async function GET(req: import("next/server").NextRequest) {
  const unauth = await requireAuth(req);
  if (unauth) return unauth;
  return handler(req);
}
export async function POST(req: import("next/server").NextRequest) {
  const unauth = await requireAuth(req);
  if (unauth) return unauth;
  return handler(req);
}

export const runtime = 'nodejs'
